# https://github.com/KFERMercer/OpenWrt-CI
#
# Copyright (C) 2019 P3TERX
#
# Copyright (C) 2020 KFERMercer
name: OpenWrt-CI

on:
  push:
    branches: 
      - master
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
permissions:
  contents: read

jobs:
  build_openwrt:
    name: Build OpenWrt Firmware
    runs-on: ubuntu-22.04
    env:
      DEBIAN_FRONTEND: noninteractive
      TZ: Asia/Shanghai

    steps:
      - name: ğŸ”¥ å®‰å…¨ç£ç›˜æ¸…ç†ï¼ˆé¿å…ç³»ç»Ÿé”™è¯¯ï¼‰
        run: |
          # 1. å®‰å…¨åˆ é™¤å¤§ç›®å½•ï¼ˆä¸åˆ é™¤ç³»ç»Ÿå…³é”®ç›®å½•ï¼‰
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/boost
          sudo rm -rf /var/lib/docker /var/lib/apt/lists/* /var/cache/apt/archives/*
          sudo rm -rf /tmp/* /var/tmp/* /home/runner/.cache/*
          
          # 2. åˆ é™¤GitHub Actionsæ—¥å¿—å’Œç¼“å­˜
          sudo rm -rf /home/runner/actions-runner/cached/_diag/*
          sudo rm -rf /home/runner/actions-runner/_work/_temp/*
          
          # 3. å¸è½½ä¸å¿…è¦çš„è½¯ä»¶åŒ…ï¼ˆé¿å…é€šé…ç¬¦åŒ¹é…é”™è¯¯ï¼‰
          sudo apt-mark hold grub-efi-amd64-signed install-info
          packages_to_remove=(
            "azure-cli*" "firefox*" "google-chrome*" "powershell*"
            "mysql*" "php*" "mongodb*" "snapd*" "mono*" "llvm*"
            "dotnet*" "openjdk*" "ghc*" "zulu*"
          )
          
          for pkg in "${packages_to_remove[@]}"; do
            sudo apt remove -y --purge $pkg 2>/dev/null || true
          done
          
          # 4. å®‰å…¨æ¸…ç†ç¼“å­˜
          sudo apt autoremove -y --purge
          sudo apt clean
          
          # 5. ä¿®å¤å¯èƒ½æŸåçš„åŒ…
          sudo apt install -f -y
          
          # æ˜¾ç¤ºç»“æœ
          df -h

      - name: ğŸš€ ä½¿ç”¨Dockerç¼–è¯‘ï¼ˆé¿å…ç³»ç»Ÿä¾èµ–é—®é¢˜ï¼‰
        run: |
          # ä½¿ç”¨OpenWrtå®˜æ–¹SDK Dockeré•œåƒ
          docker pull openwrtorg/sdk:x86-64-openwrt-23.05
          
          # åˆ›å»ºå·¥ä½œç›®å½•
          mkdir -p openwrt-work && cd openwrt-work
          
          # åœ¨Dockerä¸­ç¼–è¯‘
          docker run --rm -v $PWD:/work -w /work openwrtorg/sdk:x86-64-openwrt-23.05 \
            /bin/bash -c " \
              # æ·»åŠ feeds
              echo 'src-git helloworld https://github.com/fw876/helloworld.git' >> feeds.conf.default && \
              echo 'src-git openclash https://github.com/vernesong/OpenClash.git' >> feeds.conf.default && \
              
              # æ›´æ–°feeds
              ./scripts/feeds update helloworld openclash base luci && \
              ./scripts/feeds install -a -p helloworld && \
              ./scripts/feeds install luci-app-openclash && \
              
              # é…ç½®ç¼–è¯‘
              echo 'CONFIG_TARGET_x86_64=y' > .config && \
              echo 'CONFIG_TARGET_x86_64_Generic=y' > .config && \
              echo 'CONFIG_PACKAGE_luci-app-openclash=y' >> .config && \
              echo 'CONFIG_PACKAGE_luci-theme-bootstrap=y' >> .config && \
              echo 'CONFIG_TARGET_ROOTFS_PARTSIZE=512' >> .config && \
              
              # ç”Ÿæˆé…ç½®
              make defconfig && \
              
              # ä¸‹è½½ä¾èµ–
              make download -j4 && \
              
              # ç¼–è¯‘
              make -j$(nproc) || make -j1 V=s"

      - name: ğŸ“¦ æå–ç¼–è¯‘äº§ç‰©
        run: |
          mkdir -p ./artifact/firmware ./artifact/packages
          cp -rf openwrt-work/bin/targets/*/*/*.{gz,img} ./artifact/firmware/ || true
          cp -rf openwrt-work/bin/packages/*/*/*.ipk ./artifact/packages/ || true

      - name: ğŸ“¤ ä¸Šä¼ äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: OpenWrt-Firmware
          path: ./artifact/
          retention-days: 3
