# https://github.com/KFERMercer/OpenWrt-CI
#
# Copyright (C) 2019 P3TERX
#
# Copyright (C) 2020 KFERMercer
name: OpenWrt-CI

on:
  schedule:
    - cron: 0 20 * * *
  push:
    branches: 
      - master
permissions:
  contents: read
  actions: write

jobs:
  build_openwrt:
    name: Build OpenWrt Firmware
    runs-on: ubuntu-22.04
    env:
      DEBIAN_FRONTEND: noninteractive
      TZ: Asia/Shanghai

    steps:
      - name: ğŸš¨ ç´§æ€¥ç£ç›˜æ¸…ç†ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
        run: |
          # 1. ç«‹å³åˆ é™¤æœ€å¤§çš„ç›®å½•
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/boost
          sudo rm -rf /var/lib/docker /var/lib/apt/lists/* /var/cache/apt/*
          sudo rm -rf /tmp/* /var/tmp/* /home/runner/.cache/*
          
          # 2. åˆ é™¤GitHub Actionsæ—¥å¿—ç¼“å­˜
          sudo rm -rf /home/runner/actions-runner/cached/_diag/*
          sudo rm -rf /home/runner/actions-runner/_work/_temp/*
          
          # 3. æ˜¾ç¤ºå½“å‰ç£ç›˜ä½¿ç”¨æƒ…å†µ
          df -h
          du -sh /home/runner/*

      - name: ğŸ”§ æ·±åº¦æ¸…ç†ç³»ç»Ÿæ–‡ä»¶
        run: |
          # 1. åœæ­¢å¹¶åˆ é™¤æ‰€æœ‰Dockerèµ„æº
          sudo systemctl stop docker containerd 2>/dev/null || true
          sudo docker system prune -af --volumes 2>/dev/null || true
          sudo rm -rf /var/lib/docker /var/lib/containerd
          
          # 2. å¸è½½æ‰€æœ‰ä¸å¿…è¦çš„è½¯ä»¶åŒ…
          sudo apt-mark hold grub-efi-amd64-signed
          sudo apt remove -y --purge \
            azure-cli* firefox* google-chrome* powershell* \
            mysql* php* mongodb* snapd* mono* llvm* \
            dotnet* openjdk* ghc* zulu* || true
          
          # 3. æ¸…ç†aptç¼“å­˜å’Œæ®‹ç•™
          sudo apt autoremove -y --purge
          sudo apt clean
          sudo apt autoclean
          
          # 4. åˆ é™¤æ—¥å¿—æ–‡ä»¶
          sudo find /var/log -type f -delete
          sudo find /var/log -type d -name "journal" -exec rm -rf {} \;
          
          # 5. æ˜¾ç¤ºæ¸…ç†ç»“æœ
          echo "===== æ·±åº¦æ¸…ç†åç£ç›˜ç©ºé—´ ====="
          df -h

      - name: ğŸ“¥ æ£€å‡ºOpenWrtæºç ï¼ˆæœ€å°åŒ–ï¼‰
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          sparse-checkout: |
            .
            !.git
            !docs
            !tools
            !package/feeds

      - name: ğŸ§¹ å†æ¬¡æ¸…ç†ï¼ˆç¼–è¯‘å‰æœ€åæ¸…ç†ï¼‰
        run: |
          sudo rm -rf /home/runner/.npm /home/runner/.cache/pip /home/runner/.local
          sudo rm -rf /usr/share/doc /usr/share/man /usr/share/info
          df -h

      - name: ğŸ“¦ ç²¾ç®€é›†æˆOpenClash
        run: |
          # ä½¿ç”¨æ›´ç²¾ç®€çš„æ–¹å¼é›†æˆOpenClash
          mkdir -p package/luci-app-openclash
          cd package/luci-app-openclash
          git init
          git remote add origin https://github.com/vernesong/OpenClash.git
          git config core.sparsecheckout true
          echo "luci-app-openclash/" > .git/info/sparse-checkout
          git pull --depth=1 origin master
          cd -
          
          # åªæ›´æ–°å¿…è¦çš„feeds
          sed -i 's/#src-git helloworld/src-git helloworld/g' ./feeds.conf.default
          ./scripts/feeds update helloworld base luci
          ./scripts/feeds install -a -p helloworld

      - name: âš™ï¸ ç”Ÿæˆæœ€å°åŒ–é…ç½®
        run: |
          rm -f ./.config*
          touch ./.config

          # æœ€å°åŒ–é…ç½®ï¼Œåªä¿ç•™å¿…è¦ç»„ä»¶
          cat >> .config <<EOF
          CONFIG_TARGET_x86_64=y
          CONFIG_TARGET_x86_64_Generic=y
          CONFIG_TARGET_IMAGES_GZIP=y
          
          # åªä¿ç•™æœ€åŸºç¡€çš„LuCIå’ŒOpenClash
          CONFIG_PACKAGE_luci=y
          CONFIG_PACKAGE_luci-base=y
          CONFIG_PACKAGE_luci-app-openclash=y
          CONFIG_PACKAGE_luci-theme-bootstrap=y
          
          # OpenClashå¿…éœ€ä¾èµ–
          CONFIG_PACKAGE_dnsmasq-full=y
          CONFIG_PACKAGE_ipset=y
          CONFIG_PACKAGE_iptables-mod-tproxy=y
          CONFIG_PACKAGE_iptables-mod-extra=y
          CONFIG_PACKAGE_kmod-tun=y
          CONFIG_PACKAGE_luci-compat=y
          
          # ç²¾ç®€ç³»ç»Ÿ
          CONFIG_TARGET_KERNEL_PARTSIZE=16
          CONFIG_TARGET_ROOTFS_PARTSIZE=512
          CONFIG_ALL_NONSHARED=n
          CONFIG_ALL_KMODS=n
          CONFIG_ALL=y
          CONFIG_DEVEL=y
          CONFIG_CCACHE=y
          EOF

          sed -i 's/^[ \t]*//g' ./.config
          make defconfig

          # ç²¾ç®€ç½‘ç»œé…ç½®
          echo -e "# network config\nuci set network.lan.ipaddr='192.168.123.111'\nuci commit network" >> package/base-files/files/etc/rc.local

      - name: ğŸ“¥ ä¸‹è½½ä¾èµ–ï¼ˆé™åˆ¶å¹¶è¡Œï¼‰
        run: |
          make download -j4
          rm -rf ./dl/*.git*

      - name: ğŸ”¨ ç¼–è¯‘å›ºä»¶ï¼ˆå•çº¿ç¨‹å‡å°‘IOï¼‰
        run: |
          # ä½¿ç”¨å•çº¿ç¨‹ç¼–è¯‘å‡å°‘ä¸´æ—¶æ–‡ä»¶
          make -j1 || make -j1 V=s
          
          # ç¼–è¯‘åç«‹å³æ¸…ç†
          rm -rf ./build_dir/target-*/{toolchain,staging_dir}

      - name: ğŸ“¤ ä¸Šä¼ å›ºä»¶ï¼ˆåªä¿ç•™å¿…è¦æ–‡ä»¶ï¼‰
        uses: actions/upload-artifact@v4
        with:
          name: OpenWrt_firmware
          path: |
            ./bin/targets/*/*/*.gz
            ./bin/targets/*/*/*.img.gz
          retention-days: 1
