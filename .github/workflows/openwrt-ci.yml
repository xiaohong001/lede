# https://github.com/KFERMercer/OpenWrt-CI
#
# Copyright (C) 2019 P3TERX
#
# Copyright (C) 2020 KFERMercer
name: OpenWrt-CI

on:
  schedule:
    - cron: 0 20 * * *
  push:
    branches: 
      - master
permissions:
  contents: read
  actions: write

jobs:
  build_openwrt:
    name: Build OpenWrt Firmware
    runs-on: ubuntu-22.04
    env:
      DEBIAN_FRONTEND: noninteractive
      TZ: Asia/Shanghai

    steps:
      - name: ðŸ”§ åˆå§‹åŒ–çŽ¯å¢ƒä¸Žæ·±åº¦æ¸…ç†ç£ç›˜
        run: |
          # 1. å¼ºåˆ¶æ¸…ç†Dockeré•œåƒå’Œå®¹å™¨ï¼ˆé‡Šæ”¾å¤§é‡ç©ºé—´ï¼‰
          sudo docker stop $(sudo docker ps -aq) 2>/dev/null || true
          sudo docker rm $(sudo docker ps -aq) 2>/dev/null || true
          sudo docker rmi -f $(sudo docker images -aq) 2>/dev/null || true
          sudo docker system prune -af 2>/dev/null || true

          # 2. åˆ é™¤è¶…å¤§ç›®å½•å’Œæ— ç”¨è½¯ä»¶ï¼ˆé‡Šæ”¾~10GBï¼‰
          sudo rm -rf /usr/share/dotnet /etc/mysql /etc/php /etc/apt/sources.list.d \
                      /usr/local/lib/android /opt/ghc /usr/local/share/boost \
                      /var/cache/apt/archives /var/lib/apt/lists/* /tmp/* /var/tmp/*

          # 3. å®‰å…¨å¸è½½å·²å®‰è£…çš„å†—ä½™è½¯ä»¶åŒ…ï¼ˆé¿å…é€šé…ç¬¦é”™è¯¯ï¼‰
          sudo apt-mark hold grub-efi-amd64-signed
          # ä½¿ç”¨dpkgæŸ¥è¯¢å·²å®‰è£…åŒ…ï¼Œé¿å…ä¸å­˜åœ¨çš„åŒ…å¯¼è‡´é”™è¯¯
          packages_to_remove=$(dpkg -l | awk '/^ii/ {print $2}' | grep -E '^(azure-cli|docker|llvm|firefox|google|powershell|mysql|php|snapd|mono)')
          if [ -n "$packages_to_remove" ]; then
            sudo apt -y purge $packages_to_remove
          fi
          
          # å•ç‹¬å¤„ç†å¯èƒ½å­˜åœ¨çš„å¤§è½¯ä»¶åŒ…
          sudo apt -y purge azure-cli* 2>/dev/null || true
          sudo apt -y purge docker* 2>/dev/null || true
          sudo apt -y purge firefox* 2>/dev/null || true
          sudo apt -y purge google* 2>/dev/null || true
          sudo apt -y purge powershell* 2>/dev/null || true
          sudo apt -y purge mysql* 2>/dev/null || true
          sudo apt -y purge php* 2>/dev/null || true
          sudo apt -y purge snapd* 2>/dev/null || true
          sudo apt -y purge mono* 2>/dev/null || true
          
          sudo apt -y autoremove --purge
          sudo apt clean

          # 4. æ›´æ–°ç³»ç»Ÿå¹¶å®‰è£…ç¼–è¯‘ä¾èµ–ï¼ˆä¿®æ­£åŒ…åï¼‰
          sudo apt update
          sudo apt -y full-upgrade
          sudo apt -y install ack antlr3 asciidoc autoconf automake autopoint binutils \
                          bison build-essential bzip2 ccache clang cmake cpio curl \
                          device-tree-compiler flex gawk gcc-multilib g++-multilib \
                          gettext genisoimage git gperf haveged help2man intltool \
                          libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev \
                          libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev \
                          libncursesw5-dev libpython3-dev libreadline-dev libssl-dev \
                          libtool llvm lrzsz msmtp ninja-build p7zip p7zip-full patch \
                          pkgconf python3 python3-pyelftools python3-setuptools qemu-utils \
                          rsync scons squashfs-tools subversion swig texinfo uglifyjs \
                          upx-ucl unzip vim wget xmlto xxd zlib1g-dev ruby ruby-yaml ipset iproute2

          # 5. æ˜¾ç¤ºæ¸…ç†åŽçš„ç£ç›˜ç©ºé—´
          echo "===== æ¸…ç†åŽç£ç›˜ç©ºé—´ ====="
          df -h
          echo "=========================="

      - name: ðŸ“¥ æ£€å‡ºOpenWrtæºç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ðŸ§¹ äºŒæ¬¡æ¸…ç†ï¼ˆä¿é™©æŽªæ–½ï¼‰
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          swap-storage: true

      - name: ðŸ“¦ é›†æˆOpenClashå¹¶æ›´æ–° feeds
        run: |
          # 1. é›†æˆOpenClashï¼ˆä½¿ç”¨ç¨€ç–æ£€å‡ºï¼Œåªä¸‹è½½å¿…è¦æ–‡ä»¶ï¼‰
          mkdir -p package/luci-app-openclash
          cd package/luci-app-openclash
          git init
          git remote add -f origin https://github.com/vernesong/OpenClash.git
          git config core.sparsecheckout true
          echo "luci-app-openclash" >> .git/info/sparse-checkout
          git pull --depth 1 origin master
          git branch --set-upstream-to=origin/master master
          cd -

          # 2. ç¼–è¯‘po2lmoå·¥å…·ï¼ˆOpenClashä¾èµ–ï¼‰
          pushd package/luci-app-openclash/luci-app-openclash/tools/po2lmo
          make && sudo make install
          popd

          # 3. å¯ç”¨helloworldæºï¼ˆæä¾›æ›´å¤šä¾èµ–åŒ…ï¼‰
          sed -i 's/#src-git helloworld/src-git helloworld/g' ./feeds.conf.default
          
          # 4. æ›´æ–°å¹¶å®‰è£…feeds
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: âš™ï¸ ç”Ÿæˆé…ç½®æ–‡ä»¶
        run: |
          rm -f ./.config*
          touch ./.config

          # ç¼–è¯‘é…ç½®ï¼ˆä¼˜åŒ–é€‰åž‹ï¼Œå‡å°‘ä¸å¿…è¦ç»„ä»¶ï¼‰
          cat >> .config <<EOF
          CONFIG_TARGET_x86_64=y
          CONFIG_TARGET_x86_64_Generic=y
          CONFIG_TARGET_IMAGES_GZIP=y
          
          # åŸºç¡€åŠŸèƒ½åŒ…
          CONFIG_PACKAGE_luci-app-autoreboot=y
          CONFIG_PACKAGE_luci-app-firewall=y
          CONFIG_PACKAGE_luci-app-ramfree=y
          CONFIG_PACKAGE_luci-app-ttyd=y
          CONFIG_PACKAGE_luci-theme-bootstrap=y
          
          # æ ¸å¿ƒåŠŸèƒ½åŒ…ï¼ˆOpenClashåŠä¾èµ–ï¼‰
          CONFIG_PACKAGE_luci-app-openclash=y
          CONFIG_PACKAGE_dnsmasq-full=y
          CONFIG_PACKAGE_ipset=y
          CONFIG_PACKAGE_ip-full=y
          CONFIG_PACKAGE_ruby=y
          CONFIG_PACKAGE_ruby-yaml=y
          CONFIG_PACKAGE_unzip=y
          CONFIG_PACKAGE_iptables-mod-tproxy=y
          CONFIG_PACKAGE_iptables-mod-extra=y
          CONFIG_PACKAGE_kmod-tun=y
          CONFIG_PACKAGE_luci-compat=y
          CONFIG_PACKAGE_kmod-inet-diag=y
          
          # å¯é€‰åŠŸèƒ½åŒ…ï¼ˆæŒ‰éœ€å¯ç”¨ï¼‰
          CONFIG_PACKAGE_luci-app-turboacc=y
          CONFIG_PACKAGE_luci-app-mosdns=y
          CONFIG_PACKAGE_luci-app-usb-printer=y
          
          # ç¦ç”¨ä¸éœ€è¦çš„ç»„ä»¶
          # CONFIG_VMDK_IMAGES is not set
          # CONFIG_PACKAGE_luci-app-zerotier is not set
          # CONFIG_PACKAGE_luci-app-ipsec-server is not set
          # CONFIG_PACKAGE_luci-app-adbyby-plus is not set
          # CONFIG_PACKAGE_luci-app-unblockmusic is not set
          # CONFIG_PACKAGE_luci-app-accesscontrol is not set
          # CONFIG_PACKAGE_luci-app-diskman is not set
          # CONFIG_PACKAGE_luci-app-dockerman is not set
          # CONFIG_PACKAGE_luci-app-arpbind is not set
          # CONFIG_PACKAGE_luci-app-ipsec-vpnd is not set
          # CONFIG_PACKAGE_luci-app-n2n_v2 is not set
          # CONFIG_PACKAGE_luci-app-nlbwmon is not set
          # CONFIG_PACKAGE_luci-app-qbittorrent is not set
          # CONFIG_PACKAGE_luci-app-smartdns is not set
          # CONFIG_PACKAGE_luci-app-upnp is not set
          # CONFIG_PACKAGE_luci-app-uugamebooster is not set
          # CONFIG_PACKAGE_luci-app-vsftpd is not set
          # CONFIG_PACKAGE_luci-app-webadmin is not set
          # CONFIG_PACKAGE_luci-app-wireguard is not set
          # CONFIG_PACKAGE_luci-app-xlnetacc is not set
          # CONFIG_PACKAGE_luci-app-filetransfer is not set
          
          # åˆ†åŒºå¤§å°é…ç½®ï¼ˆæŒ‰éœ€è°ƒæ•´ï¼‰
          CONFIG_TARGET_KERNEL_PARTSIZE=32
          CONFIG_TARGET_ROOTFS_PARTSIZE=760
          
          # ç¼–è¯‘ä¼˜åŒ–ï¼ˆå‡å°‘ä½“ç§¯ï¼‰
          CONFIG_CCACHE=y
          CONFIG_CCACHE_DIR=/tmp/ccache
          CONFIG_BUILD_PATENTED=y
          CONFIG_PACKAGE_kmod-nft-tproxy=y
          EOF

          # æ¸…ç†é…ç½®æ–‡ä»¶ç©ºæ ¼å¹¶ç”Ÿæˆé»˜è®¤é…ç½®
          sed -i 's/^[ \t]*//g' ./.config
          make defconfig

          # ç½‘ç»œé…ç½®ï¼ˆæ—è·¯ç”±æ¨¡å¼ï¼‰
          sed -i "2i # network config" ./package/lean/default-settings/files/zzz-default-settings
          sed -i "3i uci set network.lan.ipaddr='192.168.123.111'" ./package/lean/default-settings/files/zzz-default-settings
          sed -i "4i uci set network.lan.proto='static'" ./package/lean/default-settings/files/zzz-default-settings
          sed -i "5i uci set network.lan.type='bridge'" ./package/lean/default-settings/files/zzz-default-settings
          sed -i "6i uci set network.lan.ifname='eth0'" ./package/lean/default-settings/files/zzz-default-settings
          sed -i "7i uci set network.lan.netmask='255.255.255.0'" ./package/lean/default-settings/files/zzz-default-settings
          sed -i "8i uci set network.lan.gateway='192.168.123.1'" ./package/lean/default-settings/files/zzz-default-settings
          sed -i "9i uci set network.lan.broadcast='192.168.123.255'" ./package/lean/default-settings/files/zzz-default-settings
          sed -i "10i uci set network.lan.dns='192.168.123.1'" ./package/lean/default-settings/files/zzz-default-settings
          sed -i "11i uci commit network\n" ./package/lean/default-settings/files/zzz-default-settings

          # æ—è·¯ç”±DHCPé…ç½®
          sed -i "12i uci set dhcp.lan=dhcp" ./package/lean/default-settings/files/zzz-default-settings
          sed -i "13i uci set dhcp.lan.interface='lan'" ./package/lean/default-settings/files/zzz-default-settings
          sed -i "14i uci set dhcp.lan.ignore='1'" ./package/lean/default-settings/files/zzz-default-settings
          sed -i "15i uci set dhcp.wan=dhcp" ./package/lean/default-settings/files/zzz-default-settings
          sed -i "16i uci set dhcp.wan.interface='wan'" ./package/lean/default-settings/files/zzz-default-settings
          sed -i "17i uci set dhcp.wan.ignore='1'" ./package/lean/default-settings/files/zzz-default-settings
          sed -i "18i uci delete dhcp.lan.dhcpv6=disabled" ./package/lean/default-settings/files/zzz-default-settings
          sed -i "19i uci delete dhcp.lan.leasetime='12h'" ./package/lean/default-settings/files/zzz-default-settings
          sed -i "20i uci delete dhcp.lan.ra='server'" ./package/lean/default-settings/files/zzz-default-settings
          sed -i "21i uci delete dhcp.lan.ra_management='1'" ./package/lean/default-settings/files/zzz-default-settings
          sed -i "22i uci delete dhcp.lan.ra_default='1'" ./package/lean/default-settings/files/zzz-default-settings
          sed -i "23i uci delete dhcp.lan.start='20'" ./package/lean/default-settings/files/zzz-default-settings
          sed -i "24i uci delete dhcp.lan.limit='40'" ./package/lean/default-settings/files/zzz-default-settings
          sed -i "25i uci delete dhcp.lan.force='1'" ./package/lean/default-settings/files/zzz-default-settings
          sed -i "26i uci commit dhcp\n" ./package/lean/default-settings/files/zzz-default-settings

      - name: ðŸ“¥ ä¸‹è½½ä¾èµ–åŒ…ï¼ˆç¼“å­˜ä¼˜åŒ–ï¼‰
        run: |
          mkdir -p /tmp/ccache
          make download -j16
          echo "===== ä¸‹è½½ä¾èµ–åŽç£ç›˜ç©ºé—´ ====="
          df -h

      - name: ðŸ”¨ ç¼–è¯‘å›ºä»¶ï¼ˆç©ºé—´ç›‘æŽ§ï¼‰
        run: |
          make -j$(nproc) || make -j1 V=s
          
          sudo rm -rf /tmp/ccache
          sudo rm -rf ./build_dir/target-*/tmp/
          
          echo "===== ç¼–è¯‘å®ŒæˆåŽç£ç›˜ç©ºé—´ ====="
          df -h
          echo "=============================="
          du -h --max-depth=1 ./bin/targets/

      - name: ðŸ“¦ å‡†å¤‡äº§ç‰©
        run: |
          mkdir -p ./artifact/package
          mkdir -p ./artifact/buildinfo
          rm -rf $(find ./bin/targets/ -type d -name "packages")
          cp -rf $(find ./bin/packages/ -type f -name "*.ipk") ./artifact/package/
          cp -rf $(find ./bin/targets/ -type f -name "*.buildinfo" -o -name "*.manifest") ./artifact/buildinfo/

      - name: ðŸ“¤ ä¸Šä¼ ç¼–è¯‘ä¿¡æ¯
        uses: actions/upload-artifact@v4
        with:
          name: OpenWrt_buildinfo
          path: ./artifact/buildinfo/
          retention-days: 3

      - name: ðŸ“¤ ä¸Šä¼ IPKåŒ…
        uses: actions/upload-artifact@v4
        with:
          name: OpenWrt_package
          path: ./artifact/package/
          retention-days: 3

      - name: ðŸ“¤ ä¸Šä¼ å›ºä»¶
        uses: actions/upload-artifact@v4
        with:
          name: OpenWrt_firmware
          path: ./bin/targets/
          retention-days: 3
