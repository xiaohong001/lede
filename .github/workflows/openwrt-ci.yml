# 
# <https://github.com/KFERMercer/OpenWrt-CI>
#
# Copyright (C) 2019 P3TERX
#
# Copyright (C) 2020 KFERMercer
#
name: OpenWrt-CI

on:
  schedule:
    - cron: 0 20 * * *
  push:
    branches: 
      - master
permissions:
  contents: read

jobs:
  build_openwrt:
    name: Build OpenWrt Firmware
    runs-on: ubuntu-22.04
    steps:
      # ========== 第一步：优先深度清理磁盘（核心优化，移到最前） ==========
      - name: 深度释放磁盘空间
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          # 删除超大预置组件（释放 10GB+ 空间）
          sudo rm -rf /usr/local/lib/android \
                      /opt/ghc \
                      /usr/share/dotnet \
                      /usr/local/share/powershell \
                      /usr/local/boost \
                      /var/lib/docker \
                      /usr/local/golang \
                      /usr/lib/jvm \
                      /tmp/* \
                      /var/tmp/*
          
          # 卸载无用软件包
          sudo apt-mark hold grub-efi-amd64-signed
          sudo apt update
          sudo apt -y purge azure-cli* docker* ghc* zulu* llvm* firefox google* dotnet* powershell* openjdk* mysql* php* mongodb* snap* nodejs* npm*
          sudo apt -y full-upgrade
          sudo apt -y autoremove --purge
          sudo apt clean
          
          # 检查剩余空间（便于调试）
          echo "=== 初始磁盘空间状态 ==="
          df -h /
          echo "=== 大目录占用 ==="
          du -sh /usr/* | sort -rh | head -10

      # ========== 补充清理 Runner 缓存 ==========
      - name: 补充清理 Runner 缓存
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          swap-storage: true

      # ========== 安装编译依赖 ==========
      - name: 安装编译依赖
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo apt -y install ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential bzip2 ccache clang cmake cpio curl device-tree-compiler flex gawk gcc-multilib g++-multilib gettext genisoimage git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev libreadline-dev libssl-dev libtool llvm lrzsz msmtp ninja-build p7zip p7zip-full patch pkgconf python3 python3-pyelftools python3-setuptools qemu-utils rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev
          sudo systemctl daemon-reload
          sudo timedatectl set-timezone "Asia/Shanghai"

      # ========== 拉取 OpenWrt 源码 ==========
      - name: Checkout OpenWrt
        uses: actions/checkout@v4

      # ========== 更新 feeds 并配置插件 ==========
      - name: Update feeds
        run: |
          # 优化 OpenClash 克隆（浅克隆+稀疏检出，减少磁盘占用）
          mkdir -p package/luci-app-openclash
          cd package/luci-app-openclash
          git init
          git remote add origin https://github.com/vernesong/OpenClash.git
          git config core.sparsecheckout true
          echo "luci-app-openclash/" >> .git/info/sparse-checkout
          git pull --depth=1 origin master
          cd -
          
          # 更新 feeds
          sed -i 's/#src-git helloworld/src-git helloworld/g' ./feeds.conf.default
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # ========== 生成编译配置文件（精简镜像格式+分区大小） ==========
      - name: Generate configuration file
        run: |
          rm -f ./.config*
          touch ./.config

          # 核心配置（精简镜像格式，减少磁盘占用）
          cat >> .config <<EOF
          CONFIG_TARGET_x86_64=y
          CONFIG_TARGET_x86_64_Generic=y
          # 仅保留GZIP压缩镜像，禁用其他格式
          CONFIG_TARGET_IMAGES_GZIP=y
          CONFIG_TARGET_IMAGES_VMDK=n
          CONFIG_TARGET_IMAGES_VDI=n
          CONFIG_TARGET_IMAGES_OVA=n
          CONFIG_TARGET_IMAGES_QCOW2=n
          CONFIG_TARGET_IMAGES_RAW=n
          # 插件配置
          CONFIG_PACKAGE_luci-app-autoreboot=y
          CONFIG_PACKAGE_luci-app-firewall=y
          CONFIG_PACKAGE_luci-app-ramfree=y
          CONFIG_PACKAGE_luci-app-ttyd=y
          CONFIG_PACKAGE_luci-theme-bootstrap=y
          CONFIG_PACKAGE_luci-app-openclash=y
          CONFIG_PACKAGE_luci-app-turboacc=y
          CONFIG_PACKAGE_luci-app-mosdns=y
          CONFIG_PACKAGE_luci-app-usb-printer=y
          # 禁用不必要的配置
          CONFIG_VMDK_IMAGES=n
          CONFIG_PACKAGE_luci-app-zerotier=n
          CONFIG_PACKAGE_luci-app-ipsec-server=n
          CONFIG_PACKAGE_luci-app-adbyby-plus=n
          CONFIG_PACKAGE_luci-app-unblockmusic=n
          CONFIG_PACKAGE_luci-app-accesscontrol=n
          CONFIG_PACKAGE_luci-app-diskman=n
          CONFIG_PACKAGE_luci-app-dockerman=n
          CONFIG_PACKAGE_luci-app-arpbind=n
          CONFIG_PACKAGE_luci-app-ipsec-vpnd=n
          CONFIG_PACKAGE_luci-app-n2n_v2=n
          CONFIG_PACKAGE_luci-app-nlbwmon=n
          CONFIG_PACKAGE_luci-app-qbittorrent=n
          CONFIG_PACKAGE_luci-app-smartdns=n
          CONFIG_PACKAGE_luci-app-upnp=n
          CONFIG_PACKAGE_luci-app-uugamebooster=n
          CONFIG_PACKAGE_luci-app-vsftpd=n
          CONFIG_PACKAGE_luci-app-webadmin=n
          CONFIG_PACKAGE_luci-app-wireguard=n
          CONFIG_PACKAGE_luci-app-xlnetacc=n
          CONFIG_PACKAGE_luci-app-filetransfer=n
          # 分区大小优化（缩小根分区，减少镜像体积）
          CONFIG_TARGET_KERNEL_PARTSIZE=32
          CONFIG_TARGET_ROOTFS_PARTSIZE=512
          # 禁用不必要的基础包
          CONFIG_PACKAGE_block-mount=n
          CONFIG_PACKAGE_automount=n
          EOF

          # 格式化配置文件
          sed -i 's/^[ \t]*//g' ./.config
          make defconfig
          
          # 网络配置（旁路由）
          sed -i "2i # network config" ./package/lean/default-settings/files/zzz-default-settings
          sed -i "3i uci set network.lan.ipaddr='192.168.123.111'" ./package/lean/default-settings/files/zzz-default-settings
          sed -i "4i uci set network.lan.proto='static'" ./package/lean/default-settings/files/zzz-default-settings
          sed -i "5i uci set network.lan.type='bridge'" ./package/lean/default-settings/files/zzz-default-settings
          sed -i "6i uci set network.lan.ifname='eth0'" ./package/lean/default-settings/files/zzz-default-settings
          sed -i "7i uci set network.lan.netmask='255.255.255.0'" ./package/lean/default-settings/files/zzz-default-settings
          sed -i "8i uci set network.lan.gateway='192.168.123.1'" ./package/lean/default-settings/files/zzz-default-settings
          sed -i "9i uci set network.lan.broadcast='192.168.123.255'" ./package/lean/default-settings/files/zzz-default-settings
          sed -i "10i uci set network.lan.dns='192.168.123.1'" ./package/lean/default-settings/files/zzz-default-settings
          sed -i "11i uci commit network\n" ./package/lean/default-settings/files/zzz-default-settings
          
          # 旁路由 DHCP 配置
          sed -i "12i uci set dhcp.lan=dhcp" ./package/lean/default-settings/files/zzz-default-settings
          sed -i "13i uci set dhcp.lan.interface='lan'" ./package/lean/default-settings/files/zzz-default-settings
          sed -i "14i uci set dhcp.lan.ignore='1'" ./package/lean/default-settings/files/zzz-default-settings
          sed -i "15i uci set dhcp.wan=dhcp" ./package/lean/default-settings/files/zzz-default-settings
          sed -i "16i uci set dhcp.wan.interface='wan'" ./package/lean/default-settings/files/zzz-default-settings
          sed -i "17i uci set dhcp.wan.ignore='1'" ./package/lean/default-settings/files/zzz-default-settings
          sed -i "18i uci delete dhcp.lan.dhcpv6=disabled" ./package/lean/default-settings/files/zzz-default-settings
          sed -i "19i uci delete dhcp.lan.leasetime='12h'" ./package/lean/default-settings/files/zzz-default-settings
          sed -i "20i uci delete dhcp.lan.ra='server'" ./package/lean/default-settings/files/zzz-default-settings
          sed -i "21i uci delete dhcp.lan.ra_management='1'" ./package/lean/default-settings/files/zzz-default-settings
          sed -i "22i uci delete dhcp.lan.ra_default='1'" ./package/lean/default-settings/files/zzz-default-settings
          sed -i "23i uci delete dhcp.lan.start='20'" ./package/lean/default-settings/files/zzz-default-settings
          sed -i "24i uci delete dhcp.lan.limit='40'" ./package/lean/default-settings/files/zzz-default-settings
          sed -i "25i uci delete dhcp.lan.force='1'" ./package/lean/default-settings/files/zzz-default-settings
          sed -i "26i uci commit dhcp\n" ./package/lean/default-settings/files/zzz-default-settings

      # ========== 下载依赖包（降低线程数） ==========
      - name: Download packages
        run: make download -j8  # 降低线程数，避免磁盘IO过载

      # ========== 编译前最后清理（释放关键空间） ==========
      - name: Pre-clean for compile
        run: |
          # 删除下载的压缩包（解压后无用，释放1-2GB）
          find ./dl -name "*.tar.gz" -o -name "*.zip" -o -name "*.7z" -o -name "*.tar.xz" | xargs rm -f
          # 删除.git目录（源码仓库文件，编译无用）
          rm -rf ./.git
          # 检查剩余空间
          echo "=== 编译前磁盘空间状态 ==="
          df -h /

      # ========== 编译固件（核心优化：降低线程+实时清理临时文件） ==========
      - name: Compile firmware
        run: |
          # 临时挂载 tmpfs 到编译临时目录（需确保Runner内存足够，Ubuntu 22.04 Runner有16GB内存）
          sudo mount -t tmpfs -o size=6G tmpfs ./tmp/
          sudo mount -t tmpfs -o size=4G tmpfs ./build_dir/target-x86_64_musl/tmp/
          
          # 降低编译线程数（避免并行生成大量临时文件）
          make -j4 || make -j1 V=s
          
          # 编译中清理临时文件（释放数GB空间）
          rm -rf ./build_dir/target-*/*/tmp/
          rm -rf ./staging_dir/target-*/*/tmp/
          rm -rf ./tmp/
          
          # 打印空间占用（便于排查）
          echo "======================="
          echo "编译后磁盘空间状态:"
          echo "======================="
          df -h
          echo "======================="
          du -h --max-depth=1 ./ --exclude=build_dir --exclude=bin
          du -h --max-depth=1 ./build_dir | head -10
          du -h --max-depth=1 ./bin

      # ========== 准备产物 ==========
      - name: Prepare artifact
        run: |
          mkdir -p ./artifact/package
          mkdir -p ./artifact/buildinfo
          rm -rf $(find ./bin/targets/ -type d -name "packages")
          cp -rf $(find ./bin/packages/ -type f -name "*.ipk") ./artifact/package/
          cp -rf $(find ./bin/targets/ -type f -name "*.buildinfo" -o -name "*.manifest") ./artifact/buildinfo/

      # ========== 上传产物 ==========
      - name: Upload buildinfo
        uses: actions/upload-artifact@v4
        with:
          name: OpenWrt_buildinfo
          path: ./artifact/buildinfo/

      - name: Upload package
        uses: actions/upload-artifact@v4
        with:
          name: OpenWrt_package
          path: ./artifact/package/

      - name: Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: OpenWrt_firmware
          path: ./bin/targets/
