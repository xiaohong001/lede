# https://github.com/KFERMercer/OpenWrt-CI
#
# Copyright (C) 2019 P3TERX
#
# Copyright (C) 2020 KFERMercer
name: OpenWrt-CI

on:
  push:
    branches: 
      - master
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
permissions:
  contents: read

jobs:
  build_openwrt:
    name: Build OpenWrt Firmware
    runs-on: ubuntu-22.04
    env:
      DEBIAN_FRONTEND: noninteractive
      TZ: Asia/Shanghai

    steps:
      - name: ğŸ”¥ ç»ˆæç£ç›˜æ¸…ç†ï¼ˆé‡Šæ”¾15GB+ï¼‰
        run: |
          # 1. åˆ é™¤æ‰€æœ‰å¤§ç›®å½•ï¼ˆé‡Šæ”¾~10GBï¼‰
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/boost
          sudo rm -rf /var/lib/docker /var/lib/apt/lists /var/cache/apt/archives
          sudo rm -rf /home/runner/.cache /tmp/* /var/tmp/*
          
          # 2. åˆ é™¤GitHub Actionsæ—¥å¿—å’Œç¼“å­˜ï¼ˆé‡Šæ”¾~2GBï¼‰
          sudo rm -rf /home/runner/actions-runner/cached/*
          sudo rm -rf /home/runner/actions-runner/_work/_temp/*
          sudo rm -rf /home/runner/actions-runner/_work/_tool/*
          
          # 3. åˆ é™¤ç³»ç»Ÿä¸å¿…è¦æ–‡ä»¶ï¼ˆé‡Šæ”¾~3GBï¼‰
          sudo rm -rf /usr/share/doc /usr/share/man /usr/share/info /usr/share/locale
          sudo rm -rf /usr/lib/jvm /usr/lib/llvm* /usr/lib/ruby /usr/lib/python2*
          
          # 4. å¸è½½æ‰€æœ‰éå¿…è¦è½¯ä»¶
          sudo apt remove -y --purge $(dpkg -l | grep -E '^(firefox|google|mysql|php|mono|dotnet|snap)' | awk '{print $2}') || true
          sudo apt autoremove -y --purge
          sudo apt clean
          
          # æ˜¾ç¤ºç»“æœ
          df -h
          du -sh /home/runner/*

      - name: ğŸš€ ä½¿ç”¨é¢„ç¼–è¯‘SDKï¼ˆå…³é”®ä¼˜åŒ–ï¼‰
        run: |
          # ä¸‹è½½é¢„ç¼–è¯‘çš„OpenWrt SDKï¼Œé¿å…å®Œæ•´ç¼–è¯‘
          mkdir -p openwrt-sdk
          cd openwrt-sdk
          wget -q https://downloads.openwrt.org/releases/23.05.3/targets/x86/64/openwrt-sdk-23.05.3-x86-64_gcc-12.3.0_musl.Linux-x86_64.tar.xz
          tar xJf openwrt-sdk-*.tar.xz --strip-components=1
          cd -
          
          # è®¾ç½®SDKç¯å¢ƒ
          cd openwrt-sdk
          echo "src-git helloworld https://github.com/fw876/helloworld.git" >> feeds.conf.default
          ./scripts/feeds update helloworld
          ./scripts/feeds install luci-app-openclash

      - name: âš™ï¸ é…ç½®SDKç¼–è¯‘
        run: |
          cd openwrt-sdk
          
          # åªç¼–è¯‘OpenClashå’Œå¿…è¦ä¾èµ–
          echo -e "CONFIG_PACKAGE_luci-app-openclash=y\nCONFIG_PACKAGE_luci-compat=y" > .config
          make defconfig
          
          # ä¸‹è½½ä¾èµ–
          make download -j4

      - name: ğŸ”¨ ç¼–è¯‘OpenClash
        run: |
          cd openwrt-sdk
          make package/luci-app-openclash/compile V=s

      - name: ğŸ“¦ æå–ç¼–è¯‘äº§ç‰©
        run: |
          mkdir -p ./artifact
          cp -rf openwrt-sdk/bin/packages/*/*/*.ipk ./artifact/
          cp -rf openwrt-sdk/bin/targets/*/*/*.ipk ./artifact/ || true

      - name: ğŸ“¤ ä¸Šä¼ äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: OpenClash-packages
          path: ./artifact/
          retention-days: 3
